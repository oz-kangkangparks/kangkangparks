name: Deploy KangKangParks

on:
  push:
    branches:
      - deploy

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix case-sensitive file names
        run: |
          # Remove lowercase files if they exist
          rm -f components/back-to-top.tsx components/canvas/hero-canvas.tsx components/canvas/hero-drawing.ts || true
          echo "âœ… Lowercase files removed (if existed)"

      - name: Create deployment archive
        run: |
          tar -czf /tmp/deploy.tar.gz --exclude='.git' --exclude='node_modules' .
          mv /tmp/deploy.tar.gz ./deploy.tar.gz
          echo "âœ… Deployment archive created"

      - name: Copy files to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          source: "deploy.tar.gz"
          target: "/tmp"

      - name: Deploy to Server (Blue-Green Deployment)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          password: ${{ secrets.SSH_PASSWORD }}
          timeout: 30m
          command_timeout: 30m
          script: |
            set -e

            # í™˜ê²½ ë³€ìˆ˜ ì •ì˜
            PROJECT_NAME="kangkangparks-frontend"
            DEPLOY_PATH="/home/kangkangparks/docker/kangkangparks/website"
            NGINX_CONF_PATH="/home/kangkangparks/docker/nginx/volumes/conf/kangkangparks.com.conf"
            NETWORK_NAME="nginx_nginx-proxy"
            NGINX_UPSTREAM_NAME="kangkangparks-frontend"

            echo "ğŸš€ Starting Blue-Green Deployment for KangKangParks..."

            # 1. í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í¬íŠ¸ í™•ì¸ (3010 ë˜ëŠ” 3011)
            if docker ps --format '{{.Names}}:{{.Ports}}' | grep -q "${PROJECT_NAME}.*0\.0\.0\.0:3010"; then
              CURRENT_PORT=3010
              NEW_PORT=3011
              OLD_CONTAINER="${PROJECT_NAME}"
              NEW_CONTAINER="${PROJECT_NAME}-green"
              OLD_IMAGE_TAG="blue"
              NEW_IMAGE_TAG="green"
              echo "ğŸ“ Current: Blue (3010) â†’ Deploying: Green (3011)"
            elif docker ps --format '{{.Names}}:{{.Ports}}' | grep -q "${PROJECT_NAME}-green.*0\.0\.0\.0:3011"; then
              CURRENT_PORT=3011
              NEW_PORT=3010
              OLD_CONTAINER="${PROJECT_NAME}-green"
              NEW_CONTAINER="${PROJECT_NAME}"
              OLD_IMAGE_TAG="green"
              NEW_IMAGE_TAG="blue"
              echo "ğŸ“ Current: Green (3011) â†’ Deploying: Blue (3010)"
            else
              # ì²« ë°°í¬
              CURRENT_PORT=""
              NEW_PORT=3010
              OLD_CONTAINER=""
              NEW_CONTAINER="${PROJECT_NAME}"
              NEW_IMAGE_TAG="blue"
              echo "ğŸ“ First deployment â†’ Deploying: Blue (3010)"
            fi

            # 2. ë„¤íŠ¸ì›Œí¬ í™•ì¸
            if ! docker network ls | grep -q "$NETWORK_NAME"; then
              echo "âŒ Error: Network $NETWORK_NAME not found"
              exit 1
            fi
            echo "âœ… Network verified"

            # 3. ì´ì „ ì‹¤íŒ¨í•œ ë°°í¬ ì •ë¦¬ (ìƒˆ ì»¨í…Œì´ë„ˆë§Œ)
            echo "ğŸ§¹ Cleaning up previous failed deployment..."
            docker stop "$NEW_CONTAINER" 2>/dev/null || true
            docker rm "$NEW_CONTAINER" 2>/dev/null || true
            docker rmi "${PROJECT_NAME}:${NEW_IMAGE_TAG}" 2>/dev/null || true
            echo "âœ… Cleanup completed"

            # 4. ë°°í¬ í´ë” ìƒì„± ë° ì••ì¶• í•´ì œ
            mkdir -p "$DEPLOY_PATH"
            cd "$DEPLOY_PATH"
            tar -xzf /tmp/deploy.tar.gz
            rm -f /tmp/deploy.tar.gz
            echo "âœ… Code extracted"

            # 5. ìƒˆ ì´ë¯¸ì§€ ë¹Œë“œ (ìµœì í™”)
            echo "ğŸ”¨ Building new image (${NEW_IMAGE_TAG})..."
            # BuildKit í™œì„±í™” + ìºì‹œ í™œìš©
            DOCKER_BUILDKIT=1 docker build \
              --pull \
              --build-arg BUILDKIT_INLINE_CACHE=1 \
              -t "${PROJECT_NAME}:${NEW_IMAGE_TAG}" \
              .
            echo "âœ… Image built"

            # 6. ìƒˆ ì»¨í…Œì´ë„ˆ ê¸°ë™ (ìƒˆ í¬íŠ¸)
            echo "ğŸš¢ Starting new container on port ${NEW_PORT}..."
            docker run -d \
              --name "$NEW_CONTAINER" \
              --network "$NETWORK_NAME" \
              -p "${NEW_PORT}:3000" \
              -e NODE_ENV=production \
              -e HOSTNAME=0.0.0.0 \
              -e TZ=Asia/Seoul \
              -e SMTP_HOST=${{ secrets.SMTP_HOST }} \
              -e SMTP_PORT=${{ secrets.SMTP_PORT }} \
              -e SMTP_USER=${{ secrets.SMTP_USER }} \
              -e SMTP_PASS=${{ secrets.SMTP_PASS }} \
              --restart unless-stopped \
              "${PROJECT_NAME}:${NEW_IMAGE_TAG}"
            echo "âœ… Container started"

            # 7. Health Check
            echo "ğŸ¥ Running health check..."
            retry_count=0
            max_retries=12

            while [ $retry_count -lt $max_retries ]; do
              if curl -f http://localhost:${NEW_PORT}/ > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                break
              fi
              echo "â³ Waiting ($retry_count/$max_retries)..."
              sleep 5
              retry_count=$((retry_count + 1))
            done

            if [ $retry_count -eq $max_retries ]; then
              echo "âŒ Health check failed! Rolling back..."
              docker stop "$NEW_CONTAINER" || true
              docker rm "$NEW_CONTAINER" || true
              docker rmi "${PROJECT_NAME}:${NEW_IMAGE_TAG}" || true
              exit 1
            fi

            # 8. nginx upstream ì „í™˜ (ë¬´ì¤‘ë‹¨!)
            echo "ğŸ”„ Switching nginx upstream..."
            cp "$NGINX_CONF_PATH" "${NGINX_CONF_PATH}.backup"

            if [ -n "$CURRENT_PORT" ]; then
              # ê¸°ì¡´ ì»¨í…Œì´ë„ˆì—ì„œ ìƒˆ ì»¨í…Œì´ë„ˆë¡œ ì „í™˜
              sed -i "s/server ${OLD_CONTAINER}:3000/server ${NEW_CONTAINER}:3000/" "$NGINX_CONF_PATH"
            else
              # ì²« ë°°í¬ - nginx upstreamì„ ìƒˆ ì»¨í…Œì´ë„ˆë¡œ ì„¤ì •
              sed -i "s/server ${NGINX_UPSTREAM_NAME}:[0-9]\+/server ${NEW_CONTAINER}:3000/" "$NGINX_CONF_PATH"
              echo "âœ… First deployment - nginx upstream configured"
            fi

            # nginx reload (0.5ì´ˆ ë‹¤ìš´íƒ€ì„)
            docker exec kangkangparks-nginx-proxy nginx -s reload
            echo "âœ… Nginx switched (< 1s downtime)"

            # 9. ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ Stabilizing..."
            sleep 5

            # 10. êµ¬ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ -n "$OLD_CONTAINER" ]; then
              echo "ğŸ§¹ Removing old container..."
              docker stop "$OLD_CONTAINER" || true
              docker rm "$OLD_CONTAINER" || true
              docker rmi "${PROJECT_NAME}:${OLD_IMAGE_TAG}" || true
              echo "âœ… Old container removed"
            fi

            # 11. ìµœì¢… ì •ë¦¬
            echo "ğŸ§¹ Final cleanup..."
            docker system prune -f

            # 12. ë°°í¬ ì™„ë£Œ
            echo "ğŸ‰ Deployment completed!"
            echo "ğŸ“Š Summary:"
            echo "  - Active: ${NEW_CONTAINER} (port ${NEW_PORT})"
            echo "  - Status: $(docker inspect -f '{{.State.Status}}' "$NEW_CONTAINER")"
            echo "  - Next deployment will use: $([ "$NEW_PORT" == "3010" ] && echo "Green (3011)" || echo "Blue (3010)")"

      - name: Notify Deployment Result
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… KangKangParks deployment succeeded!"
          else
            echo "âŒ KangKangParks deployment failed!"
          fi
